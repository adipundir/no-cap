# Walrus Fact Upload Flow - Complete Architecture

## Overview

The NOCAP application now uses a **hybrid storage architecture** combining:
- **Walrus decentralized storage** for full fact content
- **World Chain smart contract** for fact references, voting, and rewards
- **Server actions** for secure server-side processing

## Complete Flow

### 1. User Submits Fact (Frontend)

**Location**: `app/(app)/submit/page.tsx`

**Schema**: The user provides:
```typescript
interface FactSubmissionData {
  title: string                    // Max 200 chars
  description: string              // Max 10,000 chars  
  sources?: Array<{               // Optional sources
    url: string
    title: string
    accessedAt: string            // Auto-generated
  }>
  tags?: string[]                 // Optional tags
  category?: number               // 0-19 (General, Tech, Science, etc.)
  priority?: number               // 0=Low, 1=Medium, 2=High, 3=Critical
  votingPeriodHours?: number      // 24-168 hours
}
```

**UI Fields**:
- Title (required, max 200 chars)
- Summary/Context (required, max 10,000 chars)
- Sources (optional, dynamic list with URL + title)
- Tags (optional, comma-separated)
- Category dropdown (General, Technology, Science, etc.)
- Priority dropdown (Low, Medium, High, Critical)
- Optional ETH staking
- Voting period slider (24-168 hours)

### 2. Server Action Processing

**Location**: `lib/actions/submit-fact.ts`

**Function**: `prepareFactForWalrus(submissionData: FactSubmissionData)`

**Process**:
1. **Validation**:
   - Title: required, max 200 chars
   - Description: required, max 10,000 chars
   - Voting period: 24-168 hours
   - Category: 0-19
   - Priority: 0-3

2. **Walrus Content Preparation**:
   ```typescript
   const factContent: WalrusFactContent = {
     factId: 0,                           // Updated after on-chain creation
     version: 1,
     createdAt: new Date().toISOString(),
     updatedAt: new Date().toISOString(),
     
     // Core content
     title: submissionData.title.trim(),
     description: submissionData.description.trim(),
     summary: description.length > 500 
       ? description.slice(0, 497) + '...' 
       : description,
     
     // Additional data
     sources: submissionData.sources || [],
     media: [],                           // For future media attachments
     tags: submissionData.tags || [],
     category: submissionData.category || 0,
     priority: submissionData.priority || 1,
     language: 'en',
     contentType: 'text',
     checksum: ''                         // Generated by NOCAPWalrusService
   }
   ```

3. **Walrus Storage**:
   - Store content via `NOCAPWalrusService.storeFact(factContent)`
   - Generate content hash for integrity verification
   - Return `walrusBlobId` and `contentHash`

### 3. Contract Interaction

**Location**: `lib/unified-contracts.ts`

**Functions**: `submitFact()` and `submitFactWithStake()`

**Process**:
1. Call server action to prepare Walrus content
2. Submit fact reference to World Chain contract:
   ```solidity
   function submitFactReference(
       string calldata walrusBlobId,    // Walrus blob ID
       bytes32 contentHash,             // Content integrity hash
       uint256 votingPeriodHours,       // 24-168 hours
       uint8 category,                  // 0-19
       uint8 priority                   // 0-3
   ) external payable returns (uint256 factId)
   ```

**Contract Storage**:
```solidity
struct FactReference {
    uint256 id;
    address submitter;
    string walrusBlobId;        // Reference to Walrus content
    bytes32 contentHash;        // For integrity verification
    uint256 stakeAmount;        // ETH staked by submitter
    uint256 votesTrue;
    uint256 votesFalse;
    uint256 totalStaked;        // Total ETH staked by voters
    bool resolved;
    bool outcome;
    uint256 createdAt;
    uint256 deadline;
    uint256 rewardPool;
    uint8 category;
    uint8 priority;
}
```

### 4. Walrus Content Schema

**Location**: `lib/walrus-service.ts`

**Full Schema**:
```typescript
interface WalrusFactContent {
  // Metadata
  factId: number                        // Links to on-chain FactReference
  version: number                       // Content version
  createdAt: string                     // ISO timestamp
  updatedAt: string                     // ISO timestamp
  
  // Core content
  title: string                         // Fact title (max 200 chars)
  description: string                   // Full description (max 10,000 chars)
  summary: string                       // Auto-generated summary (max 500 chars)
  
  // Rich content
  sources: Array<{                      // Source references
    url: string
    title: string
    accessedAt: string
  }>
  media: Array<{                        // Future: images, videos, documents
    type: 'image' | 'video' | 'document'
    url: string
    caption?: string
    walrusBlobId?: string              // For media stored on Walrus
  }>
  tags: string[]                        // Searchable tags
  
  // Classification
  category: number                      // 0-19 categories
  priority: number                      // 0=Low, 1=Medium, 2=High, 3=Critical
  language: string                      // ISO language code
  contentType: 'text' | 'markdown' | 'html'
  
  // Integrity
  checksum: string                      // Content integrity checksum
}
```

### 5. Content Retrieval

**Server Action**: `retrieveFactFromWalrus(walrusBlobId: string)`

**Process**:
1. Fetch content from Walrus using blob ID
2. Verify content integrity using checksum
3. Return full `WalrusFactContent`

**Batch Retrieval**: `batchRetrieveFactsFromWalrus(walrusBlobIds: string[])`

## Key Benefits

### 1. **Decentralized Storage**
- Full fact content stored on Walrus (censorship-resistant)
- Only references stored on-chain (cost-efficient)
- Content integrity verified via hashes

### 2. **Rich Metadata**
- Categories and priorities for better organization
- Source tracking for fact verification
- Tags for searchability
- Version control for content updates

### 3. **Server Actions Security**
- Server-side validation and processing
- No direct client-to-Walrus communication
- Proper error handling and sanitization

### 4. **Scalable Architecture**
- On-chain storage only for essential data
- Full content in decentralized storage
- Efficient batch operations

## Usage Examples

### Basic Fact Submission
```typescript
const result = await prepareFactForWalrus({
  title: "Ethereum Cancun upgrade reduced gas fees",
  description: "The Ethereum Cancun upgrade, implemented in March 2024, introduced EIP-4844 which significantly reduced Layer 2 transaction costs...",
  category: 1, // Technology
  priority: 2, // High
  votingPeriodHours: 48
});
```

### Fact with Sources
```typescript
const result = await prepareFactForWalrus({
  title: "Climate change accelerating ice sheet loss",
  description: "Recent studies show Antarctic ice sheet loss has tripled since 2012...",
  sources: [
    {
      url: "https://nature.com/articles/climate-study-2024",
      title: "Antarctic Ice Sheet Acceleration Study",
      accessedAt: new Date().toISOString()
    }
  ],
  tags: ["climate", "antarctica", "ice", "environment"],
  category: 6, // Environment
  priority: 3, // Critical
  votingPeriodHours: 72
});
```

## Error Handling

The server action provides comprehensive error handling:
- Input validation errors
- Walrus storage failures
- Content size limits
- Network connectivity issues

All errors are returned in a structured format:
```typescript
interface FactSubmissionResult {
  success: boolean
  walrusBlobId?: string
  contentHash?: string
  factId?: number
  error?: string
}
```

## Next Steps

1. **Deploy NOCAPWalrusHybrid.sol** to World Chain mainnet
2. **Update contract address** in `WORLD_CHAIN_CONTRACTS.NOCAP_UNIFIED`
3. **Test end-to-end flow** with real Walrus storage
4. **Implement fact retrieval** in feed and detail pages
5. **Add media upload support** for images and documents

## Summary

The system now provides a clean, **Walrus-first fact upload flow**:

1. ✅ **Rich fact submission form** with sources, tags, categories, priorities
2. ✅ **Server action validation** and Walrus storage preparation  
3. ✅ **Hybrid architecture** - full content on Walrus, references on-chain
4. ✅ **Content integrity** via hash verification
5. ✅ **Scalable design** for future enhancements

The focus is on **core fact verification** without the complexity of comment systems.
